- name: Install apt package requirements
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  with_items:
    - gpg-agent
    - curl
    - procps
    - net-tools
    - gnupg

- name: Install Elasticsearch
  block:
    - name: Ensure /usr/share/keyrings directory exists
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: elasticsearch-install | Import Elasticsearch GPG Key
      ansible.builtin.get_url:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        dest: /usr/share/keyrings/elasticsearch-keyring.gpg
      register: gpg_key_download

    - name: Check if GPG key was imported successfully
      ansible.builtin.command: gpg --list-packets /usr/share/keyrings/elasticsearch-keyring.gpg
      when: gpg_key_download.changed

    - name: Add Elasticsearch APT Repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main"
        state: present
        filename: "elastic-8.x.list"
        
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install Elasticsearch package
      ansible.builtin.apt:
        name: elasticsearch
        state: present


- name: Create data directory
  file:
    path: /mnt/data/elasticsearch
    state: directory
    mode: '0755'
    owner: elasticsearch
    group: elasticsearch

- name: Ensure ownership of Elasticsearch installation directory
  command: chown -R nobody:nogroup /mnt/data/elasticsearch

- name: Ensure ownership of data directory
  file:
    path: /mnt/data/elasticsearch
    state: directory
    recurse: yes
    owner: elasticsearch
    group: elasticsearch
    
- name: Run elasticsearch-reconfigure-node with the enrollment token
  command: /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token {{ enrollment_token }}
  when: enrollment_token is defined

- name: Enable and start Elasticsearch service
  service:
    name: elasticsearch
    state: started
    enabled: yes
